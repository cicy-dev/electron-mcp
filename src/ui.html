<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Electron Window Monitor</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, sans-serif; background: #0f1117; color: #e2e8f0; min-height: 100vh; }

    /* ── Buttons ── */
    .btn {
      display: inline-flex; align-items: center; justify-content: center;
      padding: 8px 16px; border-radius: 7px; border: none; cursor: pointer;
      font-size: 0.85rem; font-weight: 500; transition: opacity 0.15s;
    }
    .btn:hover:not(:disabled) { opacity: 0.8; }
    .btn:disabled { opacity: 0.4; cursor: default; }
    .btn-primary { background: #6366f1; color: #fff; }
    .btn-success { background: #16a34a; color: #fff; }
    .btn-danger  { background: #dc2626; color: #fff; }
    .btn-ghost   { background: #1e2235; color: #94a3b8; border: 1px solid #2d3148; }
    .btn-sm      { padding: 5px 11px; font-size: 0.78rem; }
    .btn-block   { width: 100%; }

    /* ── Login ── */
    #login-view {
      display: none; align-items: center; justify-content: center; min-height: 100vh;
    }
    .login-box {
      background: #1a1d2e; border: 1px solid #2d3148; border-radius: 12px;
      padding: 40px; width: 360px;
    }
    .login-box h1 { font-size: 1.4rem; margin-bottom: 8px; }
    .login-box p  { color: #94a3b8; font-size: 0.875rem; margin-bottom: 24px; }
    .login-box input {
      width: 100%; padding: 10px 14px; border-radius: 8px;
      border: 1px solid #3d4265; background: #0f1117; color: #e2e8f0;
      font-size: 0.9rem; margin-bottom: 12px; outline: none;
    }
    .login-box input:focus { border-color: #6366f1; }
    #login-error { color: #f87171; font-size: 0.8rem; margin-top: 8px; min-height: 18px; }

    /* ── Main view (split pane) ── */
    #main-view {
      display: none;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* Top bar */
    .topbar {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 20px; gap: 8px; flex-wrap: wrap; flex-shrink: 0;
      background: #1a1d2e; border-bottom: 1px solid #2d3148;
    }
    .topbar h1 { font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }
    .topbar-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .live-dot {
      width: 8px; height: 8px; border-radius: 50%; background: #4ade80;
      animation: pulse 1.4s infinite;
    }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.25} }

    /* Grid section (top, scrollable selector) */
    .grid-section {
      overflow-y: auto;
      flex-shrink: 0;
      max-height: 28vh;
      min-height: 60px;
      border-bottom: 2px solid #2d3148;
      padding: 10px 20px 10px;
    }
    .windows-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 12px;
      transition: opacity 0.2s;
    }
    .window-card {
      background: #1a1d2e; border: 2px solid #2d3148; border-radius: 10px;
      overflow: hidden; cursor: pointer; transition: border-color 0.15s;
      position: relative;
    }
    .window-card:hover { border-color: #6366f1; }
    .window-card.selected { border-color: #6366f1; box-shadow: 0 0 0 2px rgba(99,102,241,0.35); }
    .card-close-btn {
      position: absolute; top: 5px; right: 5px;
      background: rgba(220,38,38,0.85); color: #fff; border: none;
      border-radius: 5px; padding: 2px 7px; font-size: 0.72rem; cursor: pointer;
      opacity: 0; transition: opacity 0.15s;
    }
    .window-card:hover .card-close-btn { opacity: 1; }
    .card-body { padding: 8px 10px; }
    .card-title { font-size: 0.82rem; font-weight: 600; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .card-url   { font-size: 0.68rem; color: #64748b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
    .card-meta  { display: flex; align-items: center; gap: 5px; font-size: 0.68rem; color: #94a3b8; flex-wrap: wrap; }
    .badge { display: inline-block; padding: 1px 5px; border-radius: 4px; font-size: 0.64rem; font-weight: 600; }
    .badge-green { background: #14532d; color: #4ade80; }
    .badge-gray  { background: #1e293b; color: #94a3b8; }
    .bounds-tag  { font-family: monospace; font-size: 0.68rem; color: #64748b; }
    .empty-state { text-align: center; color: #64748b; padding: 30px 20px; }
    .empty-state h2 { font-size: 1rem; margin-bottom: 6px; }

    /* Bottom pane (live capture + controls) */
    #bottom-pane {
      flex: 1; display: flex; overflow: hidden;
    }
    .bp-empty {
      flex: 1; display: flex; align-items: center; justify-content: center;
      color: #475569; font-size: 0.9rem;
    }
    .bp-capture {
      flex: 1; background: #000; display: flex;
      align-items: center; justify-content: center; overflow: hidden;
    }
    #bp-img { max-width: 100%; max-height: 100%; object-fit: contain; display: block; }
    .bp-panel {
      width: 260px; flex-shrink: 0; background: #1a1d2e;
      border-left: 1px solid #2d3148; padding: 14px;
      overflow-y: auto; display: flex; flex-direction: column; gap: 18px;
    }
    .panel-section h3 {
      font-size: 0.7rem; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.07em; color: #64748b; margin-bottom: 8px;
    }
    .info-row { font-size: 0.78rem; margin-bottom: 3px; word-break: break-all; color: #94a3b8; }
    .info-row strong { color: #e2e8f0; }
    .bounds-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 7px; margin-bottom: 9px; }
    .field { display: flex; flex-direction: column; gap: 3px; }
    .field label { font-size: 0.72rem; color: #94a3b8; }
    .field input[type="number"] {
      padding: 5px 8px; border-radius: 6px; border: 1px solid #3d4265;
      background: #0f1117; color: #e2e8f0; font-size: 0.82rem;
      width: 100%; outline: none;
    }
    .field input[type="number"]:focus { border-color: #6366f1; }
    .interval-row { display: flex; align-items: center; gap: 7px; }
    .interval-row input[type="range"] { flex: 1; accent-color: #6366f1; }
    .interval-label { font-size: 0.78rem; color: #e2e8f0; white-space: nowrap; min-width: 36px; }

    /* ── Snapshot dialog overlay ── */
    #snap-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.7); z-index: 1000;
      align-items: center; justify-content: center;
    }
    #snap-overlay.open { display: flex; }
    .snap-dialog {
      background: #1a1d2e; border: 1px solid #3d4265; border-radius: 12px;
      width: min(720px, 92vw); max-height: 80vh;
      display: flex; flex-direction: column; overflow: hidden;
    }
    .snap-dialog-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 16px; border-bottom: 1px solid #2d3148; flex-shrink: 0;
    }
    .snap-dialog-header h3 { font-size: 0.9rem; }
    .snap-dialog-body {
      overflow-y: auto; padding: 16px;
      font-family: monospace; font-size: 0.8rem; line-height: 1.6;
      color: #cbd5e1; white-space: pre-wrap; word-break: break-word;
      flex: 1;
    }

    /* ── Watch view (iframe embed) ── */
    #watch-view { display: none; }
    #watch-img { width: 100vw; height: 100vh; object-fit: contain; background: #000; display: block; }
  </style>
</head>
<body>

<!-- LOGIN VIEW -->
<div id="login-view">
  <div class="login-box">
    <h1>Window Monitor</h1>
    <p>Enter your authentication token to continue.</p>
    <input type="password" id="token-input" placeholder="Token" autocomplete="off">
    <button class="btn btn-primary btn-block" id="login-btn">Sign in</button>
    <div id="login-error"></div>
  </div>
</div>

<!-- MAIN VIEW: top grid selector + bottom detail pane -->
<div id="main-view">

  <!-- Top bar -->
  <div class="topbar">
    <h1><span class="live-dot"></span> Window Monitor</h1>
    <div class="topbar-actions">
      <button class="btn btn-ghost btn-sm" id="refresh-btn">Refresh</button>
      <button class="btn btn-danger btn-sm" id="close-all-btn">Close All</button>
      <button class="btn btn-ghost btn-sm" id="logout-btn">Logout</button>
    </div>
  </div>

  <!-- Grid selector (top, scrollable) -->
  <div class="grid-section">
    <div id="windows-grid" class="windows-grid"></div>
  </div>

  <!-- Bottom pane -->
  <div id="bottom-pane">
    <div class="bp-empty" id="bp-empty">← Select a window above to inspect it</div>
  </div>

</div>

<!-- WATCH VIEW (iframe-only, no nav chrome) -->
<div id="watch-view">
  <img id="watch-img" alt="Live capture">
</div>

<!-- WEBPAGE SNAPSHOT DIALOG -->
<div id="snap-overlay">
  <div class="snap-dialog">
    <div class="snap-dialog-header">
      <h3>Page Snapshot</h3>
      <button class="btn btn-ghost btn-sm" id="snap-close-btn">✕ Close</button>
    </div>
    <div class="snap-dialog-body" id="snap-body">Loading…</div>
  </div>
</div>

<script>
(function () {
  const TOKEN_KEY = 'ELECTRON_MCP_TOKEN';
  let watchTimer = null;
  let currentWinId = null;
  let captureInterval = 1000;
  let jpegQuality = 80;
  let captureScale = 0.5;

  function $(id) { return document.getElementById(id); }
  function getToken() { return localStorage.getItem(TOKEN_KEY) || ''; }
  function saveToken(t) { localStorage.setItem(TOKEN_KEY, t); }
  function clearToken() { localStorage.removeItem(TOKEN_KEY); }
  function tok() { return `token=${encodeURIComponent(getToken())}`; }
  function snapUrl(winId) { return `/ui/snapshot?win_id=${winId}&quality=${jpegQuality}&scale=${captureScale}&${tok()}`; }
  function escHtml(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  // ── RPC ─────────────────────────────────────────────────
  async function rpc(tool, args = {}) {
    const res = await fetch(`/rpc/${tool}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${getToken()}` },
      body: JSON.stringify(args),
    });
    if (res.status === 401) { clearToken(); showLogin(); throw new Error('Unauthorized'); }
    return res;
  }

  async function rpcJson(tool, args = {}) {
    const res = await rpc(tool, args);
    if (!res.ok) throw new Error(`rpc/${tool} → ${res.status}`);
    const data = await res.json();
    return JSON.parse(data.result.content[0].text);
  }

  function stopWatch() {
    if (watchTimer) { clearInterval(watchTimer); watchTimer = null; }
  }

  function showView(id) {
    ['login-view', 'main-view', 'watch-view'].forEach(v => {
      $(v).style.display = v === id ? (v === 'main-view' ? 'flex' : v === 'login-view' ? 'flex' : 'block') : 'none';
    });
  }

  function showLogin() { showView('login-view'); setupLogin(); }

  // ── URL param bootstrap ─────────────────────────────────
  const params = new URLSearchParams(location.search);
  const urlToken = params.get('token');
  const urlWinId = params.get('win_id');

  if (urlToken) {
    saveToken(urlToken);
    history.replaceState(null, '', location.pathname + (urlWinId ? `?win_id=${urlWinId}` : ''));
  }

  // iframe watch-only mode
  if (urlWinId) {
    showView('watch-view');
    iframeWatch(parseInt(urlWinId));
    return;
  }

  // ── Entry ───────────────────────────────────────────────
  if (!getToken()) { showView('login-view'); setupLogin(); }
  else             { showView('main-view'); loadWindows(); }

  // ── Login ───────────────────────────────────────────────
  function setupLogin() {
    const input = $('token-input');
    const btn   = $('login-btn');
    const err   = $('login-error');

    async function tryLogin() {
      const t = input.value.trim();
      if (!t) { err.textContent = 'Token required.'; return; }
      err.textContent = '';
      btn.disabled = true; btn.textContent = 'Verifying…';
      try {
        const res = await fetch('/rpc/get_windows', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${t}` },
          body: '{}',
        });
        if (res.ok) { saveToken(t); showView('main-view'); loadWindows(); }
        else        { err.textContent = 'Invalid token.'; }
      } catch { err.textContent = 'Connection error.'; }
      finally  { btn.disabled = false; btn.textContent = 'Sign in'; }
    }

    btn.onclick = tryLogin;
    input.onkeydown = e => { if (e.key === 'Enter') tryLogin(); };
  }

  // ── Grid (top selector) ─────────────────────────────────
  async function loadWindows() {
    const grid = $('windows-grid');
    const btn  = $('refresh-btn');
    grid.style.opacity = '0.5';
    if (btn) { btn.disabled = true; btn.textContent = 'Refreshing…'; }
    try {
      const wins = await rpcJson('get_windows');
      renderWindows(Array.isArray(wins) ? wins : []);
    } catch (e) {
      if (e.message !== 'Unauthorized') console.error(e);
    } finally {
      grid.style.opacity = '1';
      if (btn) { btn.disabled = false; btn.textContent = 'Refresh'; }
    }
  }

  function renderWindows(wins) {
    const grid = $('windows-grid');
    if (!wins.length) {
      grid.innerHTML = '<div class="empty-state"><h2>No windows open</h2></div>';
      return;
    }
    grid.innerHTML = wins.map(w => {
      const badge = w.isVisible
        ? '<span class="badge badge-green">visible</span>'
        : '<span class="badge badge-gray">hidden</span>';
      const { x, y, width, height } = w.bounds;
      const sel = w.id === currentWinId ? ' selected' : '';
      return `<div class="window-card${sel}" id="card-${w.id}" onclick="selectWindow(${w.id})">
        <button class="card-close-btn" onclick="event.stopPropagation();quickClose(${w.id})">✕</button>
        <div class="card-body">
          <div class="card-title">${escHtml(w.title || '(no title)')}</div>
          <div class="card-url">${escHtml(w.url || '')}</div>
          <div class="card-meta">#${w.id} ${badge} <span class="bounds-tag">${width}×${height} @(${x},${y})</span></div>
        </div>
      </div>`;
    }).join('');
  }

  $('refresh-btn').onclick = () => loadWindows();

  $('close-all-btn').onclick = async () => {
    if (!confirm('Close all windows?')) return;
    const wins = await rpcJson('get_windows').catch(() => []);
    await Promise.all((Array.isArray(wins) ? wins : []).map(w => rpc('close_window', { win_id: w.id })));
    stopWatch();
    currentWinId = null;
    showEmptyPane();
    loadWindows();
  };

  $('logout-btn').onclick = () => {
    clearToken(); stopWatch(); currentWinId = null; showLogin();
  };

  window.quickClose = async function(winId) {
    if (!confirm(`Close window #${winId}?`)) return;
    await rpc('close_window', { win_id: winId });
    if (currentWinId === winId) { stopWatch(); currentWinId = null; showEmptyPane(); }
    loadWindows();
  };

  // ── Bottom pane ─────────────────────────────────────────
  function showEmptyPane() {
    $('bottom-pane').innerHTML = '<div class="bp-empty" id="bp-empty">← Select a window above to inspect it</div>';
  }

  function buildBottomPane() {
    $('bottom-pane').innerHTML = `
      <div class="bp-capture"><img id="bp-img" alt="Live capture"></div>
      <div class="bp-panel">
        <div class="panel-section">
          <h3>Info <button class="btn btn-ghost btn-sm" id="bp-refresh-btn" style="float:right;margin-top:-2px">↻</button></h3>
          <div class="info-row"><strong id="bp-win-title"></strong></div>
          <div class="info-row" id="bp-win-url" style="font-size:0.7rem"></div>
          <div class="info-row" style="margin-top:5px;font-size:0.7rem;color:#64748b">
            Display: <span id="bp-screen-size"></span>
          </div>
        </div>
        <div class="panel-section">
          <h3>Capture interval</h3>
          <div class="interval-row">
            <input type="range" id="bp-interval" min="200" max="5000" step="100" value="${captureInterval}">
            <span class="interval-label" id="bp-interval-label">${(captureInterval/1000).toFixed(1)} s</span>
          </div>
        </div>
        <div class="panel-section">
          <h3>JPEG quality</h3>
          <div class="interval-row">
            <input type="range" id="bp-quality" min="10" max="100" step="5" value="${jpegQuality}">
            <span class="interval-label" id="bp-quality-label">${jpegQuality}</span>
          </div>
        </div>
        <div class="panel-section">
          <h3>Capture scale</h3>
          <div class="interval-row">
            <input type="range" id="bp-scale" min="0.1" max="1" step="0.1" value="${captureScale}">
            <span class="interval-label" id="bp-scale-label">${Math.round(captureScale*100)}%</span>
          </div>
        </div>
        <div class="panel-section">
          <h3>Bounds</h3>
          <div class="bounds-grid">
            <div class="field"><label>X</label><input type="number" id="bounds-x"></div>
            <div class="field"><label>Y</label><input type="number" id="bounds-y"></div>
            <div class="field"><label>Width</label><input type="number" id="bounds-w" min="100"></div>
            <div class="field"><label>Height</label><input type="number" id="bounds-h" min="100"></div>
          </div>
          <button class="btn btn-success btn-block" id="apply-bounds-btn">Apply Bounds</button>
        <div id="bounds-feedback" style="font-size:0.72rem;margin-top:6px;min-height:16px"></div>
        </div>
        <div class="panel-section">
          <button class="btn btn-danger btn-block" id="bp-close-win-btn">Close Window</button>
        </div>
      </div>`;

    // Wire controls
    $('bp-refresh-btn').onclick = () => loadDetailInfo(currentWinId);

    $('bp-interval').oninput = function() {
      captureInterval = parseInt(this.value);
      $('bp-interval-label').textContent = (captureInterval / 1000).toFixed(1) + ' s';
      if (watchTimer && window._detailTick) {
        clearInterval(watchTimer);
        watchTimer = setInterval(window._detailTick, captureInterval);
      }
    };

    $('bp-quality').oninput = function() {
      jpegQuality = parseInt(this.value);
      $('bp-quality-label').textContent = jpegQuality;
    };

    $('bp-scale').oninput = function() {
      captureScale = parseFloat(this.value);
      $('bp-scale-label').textContent = Math.round(captureScale * 100) + '%';
    };

    $('apply-bounds-btn').onclick = async () => {
      if (!currentWinId) return;
      const btn = $('apply-bounds-btn');
      const fb  = $('bounds-feedback');
      btn.disabled = true; btn.textContent = 'Applying…';
      fb.style.color = '#94a3b8'; fb.textContent = '';
      try {
        const res = await rpc('set_window_bounds', {
          win_id: currentWinId,
          x:      parseInt($('bounds-x').value),
          y:      parseInt($('bounds-y').value),
          width:  parseInt($('bounds-w').value),
          height: parseInt($('bounds-h').value),
        });
        const data = await res.json();
        const isErr = data.result?.isError;
        fb.style.color = isErr ? '#f87171' : '#4ade80';
        fb.textContent  = isErr ? (data.result?.content?.[0]?.text || 'Error') : '✓ Applied';
        await loadDetailInfo(currentWinId);
        if (window._detailTick) window._detailTick();
      } catch (e) {
        fb.style.color = '#f87171'; fb.textContent = e.message;
      } finally {
        btn.disabled = false; btn.textContent = 'Apply Bounds';
      }
    };

    $('bp-close-win-btn').onclick = async () => {
      if (!currentWinId) return;
      if (!confirm(`Close window #${currentWinId}?`)) return;
      await rpc('close_window', { win_id: currentWinId });
      stopWatch();
      currentWinId = null;
      showEmptyPane();
      loadWindows();
    };
  }

  // ── Select a window (click on card) ────────────────────
  window.selectWindow = async function(winId) {
    if (currentWinId === winId) return; // already selected

    stopWatch();

    // Highlight selected card, remove from previous
    document.querySelectorAll('.window-card.selected').forEach(el => el.classList.remove('selected'));
    const card = $(`card-${winId}`);
    if (card) card.classList.add('selected');

    currentWinId = winId;

    // Focus the Electron window so it becomes active
    rpc('control_electron_BrowserWindow', { win_id: winId, code: 'win.focus()' }).catch(() => {});

    // Build pane if first time
    if (!$('bp-img')) buildBottomPane();

    await loadDetailInfo(winId);

    // Start capture loop
    let prevUrl = null;
    const img = $('bp-img');

    async function tick() {
      if (!img) return;
      try {
        const res = await fetch(snapUrl(winId));
        if (!res.ok) return;
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        img.src = url;
        if (prevUrl) URL.revokeObjectURL(prevUrl);
        prevUrl = url;
      } catch (_) {}
    }

    window._detailTick = tick;
    tick();
    watchTimer = setInterval(tick, captureInterval);
  };

  async function loadDetailInfo(winId) {
    const wins = await rpcJson('get_windows').catch(() => []);
    const w = (Array.isArray(wins) ? wins : []).find(w => w.id === winId);
    if (!w) return;
    if ($('bp-win-title'))  $('bp-win-title').textContent  = w.title || '(no title)';
    if ($('bp-win-url'))    $('bp-win-url').textContent    = w.url   || '';
    if ($('bp-screen-size')) $('bp-screen-size').textContent = `${screen.width}×${screen.height} (×${window.devicePixelRatio})`;
    if ($('bounds-x')) {
      $('bounds-x').value = w.bounds.x;
      $('bounds-y').value = w.bounds.y;
      $('bounds-w').value = w.bounds.width;
      $('bounds-h').value = w.bounds.height;
    }
  }

  // ── iframe watch mode ───────────────────────────────────
  function iframeWatch(winId) {
    const img = $('watch-img');
    let prevUrl = null;
    async function tick() {
      try {
        const res = await fetch(snapUrl(winId));
        if (!res.ok) return;
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        img.src = url;
        if (prevUrl) URL.revokeObjectURL(prevUrl);
        prevUrl = url;
      } catch (_) {}
    }
    tick();
    setInterval(tick, 1000);
  }
})();
</script>
</body>
</html>
