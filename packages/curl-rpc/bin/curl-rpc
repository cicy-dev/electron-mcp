#!/bin/bash
# curl-rpc - è½»é‡çº§ MCP RPC è°ƒç”¨å·¥å…·ï¼Œé»˜è®¤ YAML æ ¼å¼

set -o pipefail

VERSION="1.0.3"

# é»˜è®¤é…ç½®
ELECTRON_MCP_URL="${ELECTRON_MCP_URL:-http://localhost:8101}"

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
show_help() {
  cat << 'EOF'
curl-rpc - è½»é‡çº§ MCP RPC è°ƒç”¨å·¥å…·

ç”¨æ³•: curl-rpc <command> [options]

å‘½ä»¤:
  init                          åˆå§‹åŒ–é…ç½®
  <tool_name> [key=value ...]   è°ƒç”¨å·¥å…·

é€‰é¡¹:
  --json, -j                    ä½¿ç”¨ JSON æ ¼å¼
  --help, -h                    æ˜¾ç¤ºå¸®åŠ©
  --version, -v                 æ˜¾ç¤ºç‰ˆæœ¬

ç¯å¢ƒå˜é‡:
  ELECTRON_MCP_NODE=0           é€‰æ‹©èŠ‚ç‚¹ (0, 1, 2, ...)
  DEBUG=1                       è¾“å‡ºè°ƒè¯•ä¿¡æ¯

çª—å£ç®¡ç†:
  ping                          æµ‹è¯•è¿æ¥
  open_window url=<url>         æ‰“å¼€çª—å£
  close_window win_id=<id>      å…³é—­çª—å£
  get_windows                   è·å–æ‰€æœ‰çª—å£
  get_window_info win_id=<id>   è·å–çª—å£ä¿¡æ¯

JavaScript:
  exec_js win_id=<id> code=<js> æ‰§è¡ŒJavaScript

ä¸‹è½½:
  session_download_url url=<url> save_path=<path>  ä¸‹è½½æ–‡ä»¶
  get_downloads                 è·å–ä¸‹è½½åˆ—è¡¨
  clear_downloads               æ¸…ç©ºä¸‹è½½è®°å½•

CDP:
  cdp_click win_id=<id> x=<x> y=<y>     ç‚¹å‡»
  cdp_type_text win_id=<id> text=<text> è¾“å…¥æ–‡æœ¬
  cdp_scroll win_id=<id> y=<y>          æ»šåŠ¨
  cdp_press_enter win_id=<id>           æŒ‰Enter

å‰ªè´´æ¿:
  clipboard_write_text text=<text>  å†™å…¥æ–‡æœ¬
  clipboard_read_text               è¯»å–æ–‡æœ¬

è´¦æˆ·:
  get_account accountIdx=<idx>      è·å–è´¦æˆ·
  list_accounts                     åˆ—å‡ºè´¦æˆ·

ç³»ç»Ÿ:
  exec_shell command=<cmd>          æ‰§è¡ŒShell
  get_system_info                   ç³»ç»Ÿä¿¡æ¯

ç¯å¢ƒå˜é‡:
  ELECTRON_MCP_NODE=0              é€‰æ‹©èŠ‚ç‚¹ (0, 1, 2, ...)
  DEBUG=1                         è¾“å‡ºè°ƒè¯•ä¿¡æ¯ (curl -v)

é…ç½®: ~/data/electron/curl-rpc.json

ç¤ºä¾‹:
  curl-rpc init                 åˆå§‹åŒ–é…ç½®
  curl-rpc ping                 æµ‹è¯•è¿æ¥
  curl-rpc open_window url=https://example.com
  ELECTRON_MCP_NODE=1 curl-rpc ping
  DEBUG=1 curl-rpc ping

è¯¦ç»†æ–‡æ¡£: https://github.com/cicy-dev/electron-mcp/blob/main/packages/curl-rpc/README.md
EOF
  exit 0
}
if [ -z "$1" ]; then
  echo "âŒ Error: Missing arguments"
  echo ""
  show_help
  exit 1
fi

# æ˜¾ç¤ºå¸®åŠ©
if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
  show_help
  exit 0
fi

# æ£€æŸ¥ç‰ˆæœ¬å‚æ•°
if [ "$1" = "--version" ] || [ "$1" = "-v" ]; then
  echo "curl-rpc version $VERSION"
  exit 0
fi

# init å‘½ä»¤ - åˆå§‹åŒ–é…ç½®
if [ "$1" = "init" ]; then
  CONFIG_FILE=~/data/electron/curl-rpc.json
  
  if [ ! -f "$CONFIG_FILE" ]; then
    echo "â„¹ï¸  Creating new curl-rpc.json with default configuration..."
    mkdir -p ~/data/electron
    cat > "$CONFIG_FILE" << EOF
[
  {
    "api_token": "",
    "base_url": "$ELECTRON_MCP_URL"
  }
]
EOF
    echo "âœ… Created: $CONFIG_FILE"
    echo "ğŸ“‹ Configuration: [{\"api_token\": \"***\", \"base_url\": \"$ELECTRON_MCP_URL\"}]"
    echo "ğŸ”§ Set ELECTRON_MCP_NODE=0 to use this configuration"
    echo "ğŸ“ Please edit $CONFIG_FILE to add your api_token"
    exit 0
  fi

  # è¯»å–é…ç½®
  CONFIG=$(cat "$CONFIG_FILE")
  TOTAL_NODES=$(echo "$CONFIG" | jq length)

  # æ£€æŸ¥ ELECTRON_MCP_NODE ç¯å¢ƒå˜é‡
  if [ -n "$ELECTRON_MCP_NODE" ]; then
    NODE_INDEX=$ELECTRON_MCP_NODE
    if [ "$NODE_INDEX" -ge "$TOTAL_NODES" ]; then
      echo "âŒ Error: ELECTRON_MCP_NODE=$NODE_INDEX out of range (0-$((TOTAL_NODES-1)))"
      exit 1
    fi
  else
    NODE_INDEX=0
  fi

  # è·å–æŒ‡å®šèŠ‚ç‚¹é…ç½®
  NODE_CONFIG=$(echo "$CONFIG" | jq -r --argjson idx "$NODE_INDEX" '.[$idx]')
  API_TOKEN=$(echo "$NODE_CONFIG" | jq -r '.api_token')
  BASE_URL=$(echo "$NODE_CONFIG" | jq -r '.base_url')

  # è¾“å‡ºé…ç½®ä¿¡æ¯
  if [ -n "$API_TOKEN" ] && [ "$API_TOKEN" != "null" ]; then
    MASKED_TOKEN="${API_TOKEN:0:4}***...${API_TOKEN: -4}"
  else
    MASKED_TOKEN="(empty)"
  fi
  
  echo "ğŸ“‹ Configuration: [{\"api_token\": \"$MASKED_TOKEN\", \"base_url\": \"$BASE_URL\"}]"
  echo "ğŸ—‚  Total nodes: $TOTAL_NODES"
  echo "ğŸ”‘ Token: $MASKED_TOKEN"
  echo "ğŸŒ URL: $BASE_URL"
  echo "ğŸ“ Config Path: $CONFIG_FILE"
  exit 0
fi


USE_JSON=0

# æ£€æŸ¥æ˜¯å¦æ˜¯å®Œæ•´ method æ ¼å¼ (xxx/yyy)
if [[ "$1" =~ ^[a-z_]+/[a-z_]+ ]]; then
  METHOD="$1"
  shift
  if [ "$1" = "--json" ] || [ "$1" = "-j" ]; then
    USE_JSON=1
    shift
    PARAMS="$@"
  else
    PARAMS_INPUT="$@"
  fi
# ç®€åŒ–æ ¼å¼ï¼šå·¥å…·å + key=value å‚æ•°
else
  TOOL_NAME="$1"
  shift
  METHOD="tools/call"
  
  # æ„å»º YAML å‚æ•°
  YAML_PARAMS="name: $TOOL_NAME"
  
  # è§£æ key=value å‚æ•°
  if [ $# -gt 0 ]; then
    YAML_PARAMS="${YAML_PARAMS}\narguments:"
    for arg in "$@"; do
      if [[ "$arg" =~ ^([a-zA-Z_][a-zA-Z0-9_]*)=(.+)$ ]]; then
        key="${BASH_REMATCH[1]}"
        value="${BASH_REMATCH[2]}"
        YAML_PARAMS="${YAML_PARAMS}\n  ${key}: ${value}"
      else
        echo "âŒ Error: Invalid argument format: $arg"
        echo "Expected: key=value"
        exit 1
      fi
    done
  fi
  
  PARAMS_INPUT=$(echo -e "$YAML_PARAMS")
fi

# æ£€æŸ¥ curl-rpc.json é…ç½®æ–‡ä»¶
CONFIG_FILE=~/data/electron/curl-rpc.json
if [ ! -f "$CONFIG_FILE" ]; then
  echo "âŒ Error: $CONFIG_FILE not found"
  echo "Run 'curl-rpc init' to initialize configuration"
  exit 1
fi

# è¯»å–é…ç½®
CONFIG=$(cat "$CONFIG_FILE")
TOTAL_NODES=$(echo "$CONFIG" | jq length)

# æ£€æŸ¥ ELECTRON_MCP_NODE ç¯å¢ƒå˜é‡
if [ -n "$ELECTRON_MCP_NODE" ]; then
  NODE_INDEX=$ELECTRON_MCP_NODE
  if [ "$NODE_INDEX" -ge "$TOTAL_NODES" ]; then
    echo "âŒ Error: ELECTRON_MCP_NODE=$NODE_INDEX out of range (0-$((TOTAL_NODES-1)))"
    exit 1
  fi
else
  NODE_INDEX=0
fi

# è·å–æŒ‡å®šèŠ‚ç‚¹é…ç½®
NODE_CONFIG=$(echo "$CONFIG" | jq -r --argjson idx "$NODE_INDEX" '.[$idx]')
TOKEN=$(echo "$NODE_CONFIG" | jq -r '.api_token')
ELECTRON_MCP_URL=$(echo "$NODE_CONFIG" | jq -r '.base_url')

if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
  echo "âŒ Error: api_token is empty in $CONFIG_FILE"
  echo "Please edit $CONFIG_FILE to add your api_token"
  exit 1
fi

# é»˜è®¤ YAMLï¼Œè½¬æ¢ä¸º JSON
if [ "$USE_JSON" = "0" ]; then
  # æ£€æŸ¥æ˜¯å¦å®‰è£…äº† yq
  if ! command -v yq &> /dev/null; then
    echo "âŒ Error: yq not found. Install with: pip install yq --break-system-packages"
    exit 1
  fi
  
  # è½¬æ¢ YAML åˆ° JSONï¼Œæ•è·é”™è¯¯
  PARAMS=$(echo "$PARAMS_INPUT" | yq -c . 2>&1)
  if [ $? -ne 0 ]; then
    echo "âŒ Error: Invalid YAML format"
    echo "$PARAMS"
    exit 1
  fi
  ACCEPT_HEADER="application/yaml"
else
  # éªŒè¯ JSON æ ¼å¼
  if ! echo "$PARAMS" | jq empty 2>/dev/null; then
    echo "âŒ Error: Invalid JSON format"
    echo "$PARAMS"
    exit 1
  fi
  ACCEPT_HEADER="application/json"
fi

# æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ
if ! curl --noproxy "*" -s --connect-timeout 2 $ELECTRON_MCP_URL/rpc/tools/list \
  -H "Authorization: Bearer $TOKEN" > /dev/null 2>&1; then
  echo "âŒ Error: Cannot connect to MCP server at $ELECTRON_MCP_URL"
  echo "Please check if the server is running: ./service.sh status"
  exit 1
fi

# æ‰§è¡Œè¯·æ±‚
if [ "$DEBUG" = "1" ]; then
  echo "====== DEBUG REQUEST ======"
  echo "URL: $ELECTRON_MCP_URL/rpc/$METHOD"
  echo "Headers:"
  echo "  Content-Type: application/json"
  echo "  Accept: $ACCEPT_HEADER"
  echo "  Authorization: Bearer ${TOKEN:0:8}...${TOKEN: -8}"
  echo "Body: $PARAMS"
  echo "============================"
  
  curl --noproxy "*" -v -X POST $ELECTRON_MCP_URL/rpc/$METHOD \
    -H "Content-Type: application/json" \
    -H "Accept: $ACCEPT_HEADER" \
    -H "Authorization: Bearer $TOKEN" \
    -d "$PARAMS" 2>&1
  exit 0
else
  RESPONSE=$(curl --noproxy "*" -s -w "\n%{http_code}" -X POST $ELECTRON_MCP_URL/rpc/$METHOD \
    -H "Content-Type: application/json" \
    -H "Accept: $ACCEPT_HEADER" \
    -H "Authorization: Bearer $TOKEN" \
    -d "$PARAMS" 2>&1)
fi

if [ $? -ne 0 ]; then
  echo "âŒ Error: curl command failed"
  echo "$RESPONSE"
  exit 1
fi

# åˆ†ç¦»å“åº”ä½“å’ŒçŠ¶æ€ç 
HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
BODY=$(echo "$RESPONSE" | sed '$d')

# æ£€æŸ¥ HTTP çŠ¶æ€ç 
if [ "$HTTP_CODE" != "200" ]; then
  echo "âŒ Error: HTTP $HTTP_CODE"
  echo "$BODY"
  exit 1
fi

# æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
if echo "$BODY" | jq -e '.error' > /dev/null 2>&1; then
  echo "âŒ Error from server:"
  echo "$BODY" | jq -r '.error'
  exit 1
fi

# è¾“å‡ºç»“æœ
echo "----------------"
if [ "$USE_JSON" = "0" ]; then
  echo "$BODY" | yq -r '.result.content[] | if .type == "text" then .text elif .type == "image" then "Image (\(.mimeType)): \(.data[:100])..." else . end' 2>&1
  if [ $? -ne 0 ]; then
    echo "âŒ Error: Failed to parse response"
    echo "$BODY"
    exit 1
  fi
else
  echo "$BODY" | jq -r '.result.content[] | if .type == "text" then .text elif .type == "image" then "Image (\(.mimeType)): \(.data[:100])..." else . end' 2>&1
  if [ $? -ne 0 ]; then
    echo "âŒ Error: Failed to parse response"
    echo "$BODY"
    exit 1
  fi
fi
echo "----------------"
