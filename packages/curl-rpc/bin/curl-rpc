#!/bin/bash
# curl-rpc - è½»é‡çº§ MCP RPC è°ƒç”¨å·¥å…·ï¼Œé»˜è®¤ YAML æ ¼å¼

set -o pipefail

VERSION="1.0.3"

# é»˜è®¤é…ç½®
ELECTRON_MCP_URL="${ELECTRON_MCP_URL:-http://localhost:8101}"

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
show_help() {
  cat << 'EOF'
curl-rpc - è½»é‡çº§ Electron MCP RPC å‘½ä»¤è¡Œå·¥å…·

å®‰è£…:
  npm install -g curl-rpc

ç”¨æ³•: curl-rpc <command> [options]

å‘½ä»¤:
  init                          åˆå§‹åŒ–é…ç½®
  tools [--full]                åˆ—å‡ºæ‰€æœ‰å·¥å…·
  tools <tool_name>             æŸ¥çœ‹å·¥å…·è¯¦æƒ…
  <tool_name> [key=value ...]   è°ƒç”¨å·¥å…·

é€‰é¡¹:
  --json, -j                    ä½¿ç”¨ JSON æ ¼å¼
  --help, -h                    æ˜¾ç¤ºå¸®åŠ©
  --version, -v                 æ˜¾ç¤ºç‰ˆæœ¬

ç¯å¢ƒå˜é‡:
  ELECTRON_MCP_NODE=0           é€‰æ‹©èŠ‚ç‚¹ (0, 1, 2, ...)
  DEBUG=1                       è¾“å‡ºè°ƒè¯•ä¿¡æ¯ (curl -v)

é…ç½®: ~/data/electron/curl-rpc.json

ç¤ºä¾‹:
  curl-rpc init                 åˆå§‹åŒ–é…ç½®
  curl-rpc tools                åˆ—å‡ºæ‰€æœ‰å·¥å…·
  curl-rpc tools ping           æŸ¥çœ‹ ping å·¥å…·è¯¦æƒ…
  curl-rpc ping                 æµ‹è¯•è¿æ¥
  curl-rpc open_window url=https://example.com

è¯¦ç»†æ–‡æ¡£: https://github.com/cicy-dev/electron-mcp/blob/main/packages/curl-rpc/README.md
EOF
  exit 0
}
if [ -z "$1" ]; then
  echo "âŒ Error: Missing arguments"
  echo ""
  show_help
  exit 1
fi

# æ˜¾ç¤ºå¸®åŠ©
if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
  show_help
  exit 0
fi

# æ£€æŸ¥ç‰ˆæœ¬å‚æ•°
if [ "$1" = "--version" ] || [ "$1" = "-v" ]; then
  echo "curl-rpc version $VERSION"
  exit 0
fi

# init å‘½ä»¤ - åˆå§‹åŒ–é…ç½®
if [ "$1" = "init" ]; then
  CONFIG_FILE=~/data/electron/curl-rpc.json
  
  if [ ! -f "$CONFIG_FILE" ]; then
    echo "â„¹ï¸  Creating new curl-rpc.json with default configuration..."
    mkdir -p ~/data/electron
    cat > "$CONFIG_FILE" << EOF
[
  {
    "api_token": "",
    "base_url": "$ELECTRON_MCP_URL"
  }
]
EOF
    echo "âœ… Created: $CONFIG_FILE"
    echo "ğŸ“‹ Configuration: [{\"api_token\": \"***\", \"base_url\": \"$ELECTRON_MCP_URL\"}]"
    echo "ğŸ”§ Set ELECTRON_MCP_NODE=0 to use this configuration"
    echo "ğŸ“ Please edit $CONFIG_FILE to add your api_token"
    exit 0
  fi

  # è¯»å–é…ç½®
  CONFIG=$(cat "$CONFIG_FILE")
  TOTAL_NODES=$(echo "$CONFIG" | jq length)

  # æ£€æŸ¥ ELECTRON_MCP_NODE ç¯å¢ƒå˜é‡
  if [ -n "$ELECTRON_MCP_NODE" ]; then
    NODE_INDEX=$ELECTRON_MCP_NODE
    if [ "$NODE_INDEX" -ge "$TOTAL_NODES" ]; then
      echo "âŒ Error: ELECTRON_MCP_NODE=$NODE_INDEX out of range (0-$((TOTAL_NODES-1)))"
      exit 1
    fi
  else
    NODE_INDEX=0
  fi

  # è·å–æŒ‡å®šèŠ‚ç‚¹é…ç½®
  NODE_CONFIG=$(echo "$CONFIG" | jq -r --argjson idx "$NODE_INDEX" '.[$idx]')
  API_TOKEN=$(echo "$NODE_CONFIG" | jq -r '.api_token')
  BASE_URL=$(echo "$NODE_CONFIG" | jq -r '.base_url')

  # è¾“å‡ºé…ç½®ä¿¡æ¯
  if [ -n "$API_TOKEN" ] && [ "$API_TOKEN" != "null" ]; then
    MASKED_TOKEN="${API_TOKEN:0:4}***...${API_TOKEN: -4}"
  else
    MASKED_TOKEN="(empty)"
  fi
  
  echo "ğŸ“‹ Configuration: [{\"api_token\": \"$MASKED_TOKEN\", \"base_url\": \"$BASE_URL\"}]"
  echo "ğŸ—‚  Total nodes: $TOTAL_NODES"
  echo "ğŸ”‘ Token: $MASKED_TOKEN"
  echo "ğŸŒ URL: $BASE_URL"
  echo "ğŸ“ Config Path: $CONFIG_FILE"
  exit 0
fi

# tools å‘½ä»¤ - åˆ—å‡ºæ‰€æœ‰å·¥å…·
if [ "$1" = "tools" ]; then
  CONFIG_FILE=~/data/electron/curl-rpc.json
  TOKEN=$(jq -r '.[0].api_token' "$CONFIG_FILE")
  BASE_URL=$(jq -r '.[0].base_url' "$CONFIG_FILE")
  
  RESPONSE=$(curl --noproxy "*" -s -X GET "$BASE_URL/rpc/tools" \
    -H "Accept: application/json" \
    -H "Authorization: Bearer $TOKEN")
  
  # æŸ¥çœ‹å•ä¸ªå·¥å…·è¯¦æƒ…
  if [ -n "$2" ] && [ "$2" != "--full" ]; then
    TOOL_NAME="$2"
    TOOL_INFO=$(echo "$RESPONSE" | jq -r ".tools[] | select(.name == \"$TOOL_NAME\")")
    if [ "$TOOL_INFO" = "null" ] || [ -z "$TOOL_INFO" ]; then
      echo "Error: Tool '$TOOL_NAME' not found"
      exit 1
    fi
    
    NAME=$(echo "$TOOL_INFO" | jq -r '.name')
    DESC=$(echo "$TOOL_INFO" | jq -r '.description')
    echo "$NAME - $DESC"
    
    PROPS=$(echo "$TOOL_INFO" | jq -r 'if .inputSchema.properties == null then "{}" else .inputSchema.properties end')
    REQUIRED=$(echo "$TOOL_INFO" | jq -r 'if .inputSchema.required == null then "" else [.inputSchema.required[]] | join(",") end')
    
    if [ "$PROPS" != "{}" ] && [ -n "$PROPS" ]; then
      for key in $(echo "$PROPS" | jq -r 'keys[]'); do
        PTYPE=$(echo "$PROPS" | jq -r ".$key.type")
        PDEFAULT=$(echo "$PROPS" | jq -r ".$key.default // \"\"")
        PDESC=$(echo "$PROPS" | jq -r ".$key.description // \"\"")
        if echo ",$REQUIRED," | grep -q ",$key,"; then
          echo "  - $key* ($PTYPE): $PDESC"
        else
          echo "  - $key? ($PTYPE): $PDESC"
        fi
        if [ -n "$PDEFAULT" ]; then
          echo "    default: $PDEFAULT"
        fi
      done
    fi
    exit 0
  fi
  
  # æ£€æŸ¥æ˜¯å¦æœ‰ --full å‚æ•°
  if [ "$2" = "--full" ]; then
    # å®Œæ•´æ ¼å¼: name - desc\n  - param: desc
    for tool in $(echo "$RESPONSE" | jq -r '.tools[] | @base64'); do
      NAME=$(echo "$tool" | base64 -d | jq -r '.name')
      DESC=$(echo "$tool" | base64 -d | jq -r '.description')
      echo "$NAME - $DESC"
      
      PROPS=$(echo "$tool" | base64 -d | jq -r 'if .inputSchema.properties == null then "{}" else .inputSchema.properties end')
      REQUIRED=$(echo "$tool" | base64 -d | jq -r 'if .inputSchema.required == null then "" else [.inputSchema.required[]] | join(",") end')
      
      if [ "$PROPS" != "{}" ] && [ -n "$PROPS" ]; then
        for key in $(echo "$PROPS" | jq -r 'keys[]'); do
          PTYPE=$(echo "$PROPS" | jq -r ".$key.type")
          PDESC=$(echo "$PROPS" | jq -r ".$key.description // \"\"")
          if echo ",$REQUIRED," | grep -q ",$key,"; then
            echo "  - $key* ($PTYPE): $PDESC"
          else
            echo "  - $key? ($PTYPE): $PDESC"
          fi
        done
      fi
    done
  else
    # ç®€çŸ­æ ¼å¼: name - description
    echo "$RESPONSE" | jq -r '.tools[] | .name + " - " + .description'
  fi
  exit 0
fi


USE_JSON=0

# æ£€æŸ¥æ˜¯å¦æ˜¯å®Œæ•´ method æ ¼å¼ (xxx/yyy)
if [[ "$1" =~ ^[a-z_]+/[a-z_]+ ]]; then
  METHOD="$1"
  shift
  if [ "$1" = "--json" ] || [ "$1" = "-j" ]; then
    USE_JSON=1
    shift
    PARAMS="$@"
  else
    PARAMS_INPUT="$@"
  fi
# ç®€åŒ–æ ¼å¼ï¼šå·¥å…·å + key=value å‚æ•°
else
  TOOL_NAME="$1"
  shift
  METHOD="tools/call"
  
  # æ„å»º YAML å‚æ•°
  YAML_PARAMS="name: $TOOL_NAME"
  
  # è§£æ key=value å‚æ•°
  if [ $# -gt 0 ]; then
    YAML_PARAMS="${YAML_PARAMS}\narguments:"
    for arg in "$@"; do
      if [[ "$arg" =~ ^([a-zA-Z_][a-zA-Z0-9_]*)=(.+)$ ]]; then
        key="${BASH_REMATCH[1]}"
        value="${BASH_REMATCH[2]}"
        YAML_PARAMS="${YAML_PARAMS}\n  ${key}: ${value}"
      else
        echo "âŒ Error: Invalid argument format: $arg"
        echo "Expected: key=value"
        exit 1
      fi
    done
  fi
  
  PARAMS_INPUT=$(echo -e "$YAML_PARAMS")
fi

# æ£€æŸ¥ curl-rpc.json é…ç½®æ–‡ä»¶
CONFIG_FILE=~/data/electron/curl-rpc.json
if [ ! -f "$CONFIG_FILE" ]; then
  echo "âŒ Error: $CONFIG_FILE not found"
  echo "Run 'curl-rpc init' to initialize configuration"
  exit 1
fi

# è¯»å–é…ç½®
CONFIG=$(cat "$CONFIG_FILE")
TOTAL_NODES=$(echo "$CONFIG" | jq length)

# æ£€æŸ¥ ELECTRON_MCP_NODE ç¯å¢ƒå˜é‡
if [ -n "$ELECTRON_MCP_NODE" ]; then
  NODE_INDEX=$ELECTRON_MCP_NODE
  if [ "$NODE_INDEX" -ge "$TOTAL_NODES" ]; then
    echo "âŒ Error: ELECTRON_MCP_NODE=$NODE_INDEX out of range (0-$((TOTAL_NODES-1)))"
    exit 1
  fi
else
  NODE_INDEX=0
fi

# è·å–æŒ‡å®šèŠ‚ç‚¹é…ç½®
NODE_CONFIG=$(echo "$CONFIG" | jq -r --argjson idx "$NODE_INDEX" '.[$idx]')
TOKEN=$(echo "$NODE_CONFIG" | jq -r '.api_token')
ELECTRON_MCP_URL=$(echo "$NODE_CONFIG" | jq -r '.base_url')

if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
  echo "âŒ Error: api_token is empty in $CONFIG_FILE"
  echo "Please edit $CONFIG_FILE to add your api_token"
  exit 1
fi

# é»˜è®¤ YAMLï¼Œè½¬æ¢ä¸º JSON
if [ "$USE_JSON" = "0" ]; then
  # æ£€æŸ¥æ˜¯å¦å®‰è£…äº† yq
  if ! command -v yq &> /dev/null; then
    echo "âŒ Error: yq not found. Install with: pip install yq --break-system-packages"
    exit 1
  fi
  
  # è½¬æ¢ YAML åˆ° JSONï¼Œæ•è·é”™è¯¯
  PARAMS=$(echo "$PARAMS_INPUT" | yq -c . 2>&1)
  if [ $? -ne 0 ]; then
    echo "âŒ Error: Invalid YAML format"
    echo "$PARAMS"
    exit 1
  fi
  ACCEPT_HEADER="application/yaml"
else
  # éªŒè¯ JSON æ ¼å¼
  if ! echo "$PARAMS" | jq empty 2>/dev/null; then
    echo "âŒ Error: Invalid JSON format"
    echo "$PARAMS"
    exit 1
  fi
  ACCEPT_HEADER="application/json"
fi

# æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ
if ! curl --noproxy "*" -s --connect-timeout 2 $ELECTRON_MCP_URL/rpc/tools/list \
  -H "Authorization: Bearer $TOKEN" > /dev/null 2>&1; then
  echo "âŒ Error: Cannot connect to MCP server at $ELECTRON_MCP_URL"
  echo "Please check if the server is running: ./service.sh status"
  exit 1
fi

# æ‰§è¡Œè¯·æ±‚
if [ "$DEBUG" = "1" ]; then
  echo "====== DEBUG REQUEST ======"
  echo "URL: $ELECTRON_MCP_URL/rpc/$METHOD"
  echo "Headers:"
  echo "  Content-Type: application/json"
  echo "  Accept: $ACCEPT_HEADER"
  echo "  Authorization: Bearer ${TOKEN:0:8}...${TOKEN: -8}"
  echo "Body: $PARAMS"
  echo "============================"
  
  curl --noproxy "*" -v -X POST $ELECTRON_MCP_URL/rpc/$METHOD \
    -H "Content-Type: application/json" \
    -H "Accept: $ACCEPT_HEADER" \
    -H "Authorization: Bearer $TOKEN" \
    -d "$PARAMS" 2>&1
  exit 0
else
  RESPONSE=$(curl --noproxy "*" -s -w "\n%{http_code}" -X POST $ELECTRON_MCP_URL/rpc/$METHOD \
    -H "Content-Type: application/json" \
    -H "Accept: $ACCEPT_HEADER" \
    -H "Authorization: Bearer $TOKEN" \
    -d "$PARAMS" 2>&1)
fi

if [ $? -ne 0 ]; then
  echo "âŒ Error: curl command failed"
  echo "$RESPONSE"
  exit 1
fi

# åˆ†ç¦»å“åº”ä½“å’ŒçŠ¶æ€ç 
HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
BODY=$(echo "$RESPONSE" | sed '$d')

# æ£€æŸ¥ HTTP çŠ¶æ€ç 
if [ "$HTTP_CODE" != "200" ]; then
  echo "âŒ Error: HTTP $HTTP_CODE"
  echo "$BODY"
  exit 1
fi

# æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
if echo "$BODY" | jq -e '.error' > /dev/null 2>&1; then
  echo "âŒ Error from server:"
  echo "$BODY" | jq -r '.error'
  exit 1
fi

# è¾“å‡ºç»“æœ
echo "----------------"
if [ "$USE_JSON" = "0" ]; then
  echo "$BODY" | yq -r '.result.content[] | if .type == "text" then .text elif .type == "image" then "Image (\(.mimeType)): \(.data[:100])..." else . end' 2>&1
  if [ $? -ne 0 ]; then
    echo "âŒ Error: Failed to parse response"
    echo "$BODY"
    exit 1
  fi
else
  echo "$BODY" | jq -r '.result.content[] | if .type == "text" then .text elif .type == "image" then "Image (\(.mimeType)): \(.data[:100])..." else . end' 2>&1
  if [ $? -ne 0 ]; then
    echo "âŒ Error: Failed to parse response"
    echo "$BODY"
    exit 1
  fi
fi
echo "----------------"
